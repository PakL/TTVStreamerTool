

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: lib/cockpit.js | TTVST</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 0px; height: 0px">
        <img src="img/toast-ui.png" width="100%" height="100%">
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">TTVST</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
        <ol class="lnb-tab">
            <li id="api-tab">
                <a href="#"><h4>API</h4></a>
            </li>
            <li id="examples-tab">
                <a href="#"><h4>Tutorials</h4></a>
            </li>
        </ol>
    
    <div class="lnb-examples hidden"><h3>Tutorials</h3><ul><li><a href="tutorial-Getting Started.html">Getting Started</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Getting Started_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="Addons.html">Addons</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Addons_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Addons.html#menu">menu</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Addons.html#addonInstalled">addonInstalled</a></li><li><a href="Addons.html#getAddon">getAddon</a></li><li><a href="Addons.html#getInstalledAddonVersion">getInstalledAddonVersion</a></li></ul></div></li><li><a href="Channel.html">Channel</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Channel_sub"><div class="member-type">Events</div><ul class="inner"><li><a href="Channel.html#event:channeloffline">channeloffline</a></li><li><a href="Channel.html#event:channelonline">channelonline</a></li><li><a href="Channel.html#event:gamechange">gamechange</a></li><li><a href="Channel.html#event:statuschange">statuschange</a></li><li><a href="Channel.html#event:viewers">viewers</a></li></ul></div></li><li><a href="Chat.html">Chat</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Chat_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Chat.html#connected">connected</a></li><li><a href="Chat.html#irc">irc</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Chat.html#auth">auth</a></li><li><a href="Chat.html#disconnect">disconnect</a></li><li><a href="Chat.html#getUserObjByTags">getUserObjByTags</a></li><li><a href="Chat.html#join">join</a></li><li><a href="Chat.html#part">part</a></li><li><a href="Chat.html#sendmsg">sendmsg</a></li><li><a href="Chat.html#showmsg">showmsg</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="Chat.html#event:autohostingyou">autohostingyou</a></li><li><a href="Chat.html#event:chatmessage">chatmessage</a></li><li><a href="Chat.html#event:clearchat">clearchat</a></li><li><a href="Chat.html#event:clearuser">clearuser</a></li><li><a href="Chat.html#event:connected">connected</a></li><li><a href="Chat.html#event:hostingyou">hostingyou</a></li><li><a href="Chat.html#event:join">join</a></li><li><a href="Chat.html#event:names">names</a></li><li><a href="Chat.html#event:part">part</a></li><li><a href="Chat.html#event:usernotice">usernotice</a></li><li><a href="Chat.html#event:userstate">userstate</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="Chat.html#~userObject">userObject</a></li></ul></div></li><li><a href="Cockpit.html">Cockpit</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Cockpit_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Cockpit.html#isChannelOnline">isChannelOnline</a></li><li><a href="Cockpit.html#localizedName">localizedName</a></li><li><a href="Cockpit.html#name">name</a></li><li><a href="Cockpit.html#openChannelId">openChannelId</a></li><li><a href="Cockpit.html#openChannelObject">openChannelObject</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Cockpit.html#close">close</a></li><li><a href="Cockpit.html#leaveChannel">leaveChannel</a></li><li><a href="Cockpit.html#loadMoreFollows">loadMoreFollows</a></li><li><a href="Cockpit.html#open">open</a></li><li><a href="Cockpit.html#openChannel">openChannel</a></li><li><a href="Cockpit.html#searchGame">searchGame</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="Cockpit.html#event:channelleft">channelleft</a></li><li><a href="Cockpit.html#event:channelopen">channelopen</a></li></ul></div></li><li><a href="Follows.html">Follows</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Follows_sub"></div></li><li><a href="Overlays.html">Overlays</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Overlays_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="Overlays.html#allowedFiles">allowedFiles</a></li><li><a href="Overlays.html#localizedName">localizedName</a></li><li><a href="Overlays.html#name">name</a></li><li><a href="Overlays.html#overlayport">overlayport</a></li><li><a href="Overlays.html#overlayserver">overlayserver</a></li><li><a href="Overlays.html#wsport">wsport</a></li><li><a href="Overlays.html#wsserver">wsserver</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="Overlays.html#broadcastWsMessage">broadcastWsMessage</a></li><li><a href="Overlays.html#close">close</a></li><li><a href="Overlays.html#disableOverlayHotkeys">disableOverlayHotkeys</a></li><li><a href="Overlays.html#open">open</a></li></ul></div></li><li><a href="ToolSettings.html">ToolSettings</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ToolSettings_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="ToolSettings.html#autoRecoverMessages">autoRecoverMessages</a></li><li><a href="ToolSettings.html#highlights">highlights</a></li><li><a href="ToolSettings.html#language">language</a></li><li><a href="ToolSettings.html#menu">menu</a></li><li><a href="ToolSettings.html#showLocalizedNames">showLocalizedNames</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="ToolSettings.html#addHighlight">addHighlight</a></li><li><a href="ToolSettings.html#getBoolean">getBoolean</a></li><li><a href="ToolSettings.html#getJSON">getJSON</a></li><li><a href="ToolSettings.html#getString">getString</a></li><li><a href="ToolSettings.html#setBoolean">setBoolean</a></li><li><a href="ToolSettings.html#setJSON">setJSON</a></li><li><a href="ToolSettings.html#setLanguage">setLanguage</a></li><li><a href="ToolSettings.html#setString">setString</a></li></ul></div></li><li><a href="ToolUI.html">ToolUI</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="ToolUI_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="ToolUI.html#currentPage">currentPage</a></li><li><a href="ToolUI.html#loadingElement">loadingElement</a></li><li><a href="ToolUI.html#pageBefore">pageBefore</a></li><li><a href="ToolUI.html#pages">pages</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="ToolUI.html#addMenu">addMenu</a></li><li><a href="ToolUI.html#addPage">addPage</a></li><li><a href="ToolUI.html#findPage">findPage</a></li><li><a href="ToolUI.html#getMenuItemById">getMenuItemById</a></li><li><a href="ToolUI.html#openPage">openPage</a></li><li><a href="ToolUI.html#showErrorMessage">showErrorMessage</a></li><li><a href="ToolUI.html#startLoading">startLoading</a></li><li><a href="ToolUI.html#stopLoading">stopLoading</a></li></ul></div></li><li><a href="TTVLogin.html">TTVLogin</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TTVLogin_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="TTVLogin.html#menu">menu</a></li><li><a href="TTVLogin.html#userid">userid</a></li><li><a href="TTVLogin.html#username">username</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="TTVLogin.html#auth">auth</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="TTVLogin.html#event:complete">complete</a></li></ul></div></li><li><a href="TTVTool.html">TTVTool</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TTVTool_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="TTVTool.html#addons">addons</a></li><li><a href="TTVTool.html#auth">auth</a></li><li><a href="TTVTool.html#channel">channel</a></li><li><a href="TTVTool.html#chat">chat</a></li><li><a href="TTVTool.html#cockpit">cockpit</a></li><li><a href="TTVTool.html#follows">follows</a></li><li><a href="TTVTool.html#i18n">i18n</a></li><li><a href="TTVTool.html#overlays">overlays</a></li><li><a href="TTVTool.html#settings">settings</a></li><li><a href="TTVTool.html#subscriptions">subscriptions</a></li><li><a href="TTVTool.html#twitchapi">twitchapi</a></li><li><a href="TTVTool.html#ui">ui</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="TTVTool.html#event:exit">exit</a></li><li><a href="TTVTool.html#event:load">load</a></li></ul></div></li><li><a href="TwitchChat.html">TwitchChat</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TwitchChat_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="TwitchChat.html#options">options</a></li><li><a href="TwitchChat.html#socket">socket</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="TwitchChat.html#join">join</a></li><li><a href="TwitchChat.html#part">part</a></li><li><a href="TwitchChat.html#say">say</a></li><li><a href="TwitchChat.html#sendCLRF">sendCLRF</a></li></ul><div class="member-type">Events</div><ul class="inner"><li><a href="TwitchChat.html#event:action">action</a></li><li><a href="TwitchChat.html#event:autohostingyou">autohostingyou</a></li><li><a href="TwitchChat.html#event:capack">capack</a></li><li><a href="TwitchChat.html#event:clearchat">clearchat</a></li><li><a href="TwitchChat.html#event:clearuser">clearuser</a></li><li><a href="TwitchChat.html#event:close">close</a></li><li><a href="TwitchChat.html#event:connect">connect</a></li><li><a href="TwitchChat.html#event:error">error</a></li><li><a href="TwitchChat.html#event:hostingyou">hostingyou</a></li><li><a href="TwitchChat.html#event:incoming">incoming</a></li><li><a href="TwitchChat.html#event:join">join</a></li><li><a href="TwitchChat.html#event:message">message</a></li><li><a href="TwitchChat.html#event:mode">mode</a></li><li><a href="TwitchChat.html#event:mode+">mode+</a></li><li><a href="TwitchChat.html#event:mode-">mode-</a></li><li><a href="TwitchChat.html#event:motd">motd</a></li><li><a href="TwitchChat.html#event:names">names</a></li><li><a href="TwitchChat.html#event:notice">notice</a></li><li><a href="TwitchChat.html#event:outgoing">outgoing</a></li><li><a href="TwitchChat.html#event:part">part</a></li><li><a href="TwitchChat.html#event:raw">raw</a></li><li><a href="TwitchChat.html#event:registered">registered</a></li><li><a href="TwitchChat.html#event:roomstate">roomstate</a></li><li><a href="TwitchChat.html#event:usernotice">usernotice</a></li><li><a href="TwitchChat.html#event:userstate">userstate</a></li><li><a href="TwitchChat.html#event:whisper">whisper</a></li></ul></div></li><li><a href="TwitchTv.html">TwitchTv</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="TwitchTv_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="TwitchTv.html#channelid">channelid</a></li><li><a href="TwitchTv.html#channelobj">channelobj</a></li><li><a href="TwitchTv.html#clientid">clientid</a></li><li><a href="TwitchTv.html#redirecturi">redirecturi</a></li><li><a href="TwitchTv.html#scope">scope</a></li><li><a href="TwitchTv.html#userid">userid</a></li><li><a href="TwitchTv.html#userobj">userobj</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="TwitchTv.html#getAuthImplicitGrantFlowUrl">getAuthImplicitGrantFlowUrl</a></li><li><a href="TwitchTv.html#getAuthToken">getAuthToken</a></li><li><a href="TwitchTv.html#getChannel">getChannel</a></li><li><a href="TwitchTv.html#getChannelFollowers">getChannelFollowers</a></li><li><a href="TwitchTv.html#getChannelSubscribers">getChannelSubscribers</a></li><li><a href="TwitchTv.html#getChatBadgesByChannel">getChatBadgesByChannel</a></li><li><a href="TwitchTv.html#getChatBadgeSetsByChannel">getChatBadgeSetsByChannel</a></li><li><a href="TwitchTv.html#getChatEmoticonsBySet">getChatEmoticonsBySet</a></li><li><a href="TwitchTv.html#getStreamByUser">getStreamByUser</a></li><li><a href="TwitchTv.html#getUser">getUser</a></li><li><a href="TwitchTv.html#getUserByName">getUserByName</a></li><li><a href="TwitchTv.html#getUserFollows">getUserFollows</a></li><li><a href="TwitchTv.html#isLoggedIn">isLoggedIn</a></li><li><a href="TwitchTv.html#requestAPI">requestAPI</a></li><li><a href="TwitchTv.html#searchGames">searchGames</a></li><li><a href="TwitchTv.html#setAuthToken">setAuthToken</a></li><li><a href="TwitchTv.html#updateChannel">updateChannel</a></li><li><a href="TwitchTv.html#verifyState">verifyState</a></li></ul><div class="member-type">Typedef</div><ul class="inner"><li><a href="TwitchTv.html#~requestCallback">requestCallback</a></li></ul></div></li><li><a href="UIPage.html">UIPage</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="UIPage_sub"><div class="member-type">Members</div><ul class="inner"><li><a href="UIPage.html#localizedName">localizedName</a></li><li><a href="UIPage.html#name">name</a></li></ul><div class="member-type">Methods</div><ul class="inner"><li><a href="UIPage.html#close">close</a></li><li><a href="UIPage.html#open">open</a></li></ul></div></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict"

const UIPage = require('../mod/uipage')

/**
 * This is the main page. It contains the channel selection and chat
 * 
 * @class Cockpit
 * @extends {UIPage}
 * @param {ToolUI} toolui
 * @fires Cockpit#channelopen
 * @fires Cockpit#channelleft
 */
class Cockpit extends UIPage {

	constructor(toolui) {
		super('Cockpit')

		this._visible = false
		this._ui = toolui
		/**
		 * The id of the currently open channel. Might be empty if no channel is open.
		 * @member {String}
		 */
		this.openChannelId = ''
		/**
		 * Is true when the channel is online. false when not. Is true if no channel is open.
		 * @member {Boolean}
		 */
		this.isChannelOnline = true
		/**
		 * The twitch api object of the currently open channel. Has no properties when no channel is open.
		 * @member {Object}
		 * @see {@link https://dev.twitch.tv/docs/v5/reference/channels/#get-channel-by-id}
		 */
		this.openChannelObject = {}

		
		this.followsOffset = 0
		this.followsElement = null
		this.followChannels = []

		this.channelActionsElement = null
		this.channelViewersplotter = null
		this.channelOpenInputElement = null

		this.chatelement = null
		this.userselement = null
		this.messagelement = null

		this.emoticons = null
		this.emoticons_data = {emoticon_sets:{}}
		this.emoticons_container = null
		this.emoticons_button = null
		this.emoticons_search = null

		this.isGameSearching = false
		this.gameSearchTO = null
		this.lastGameSearchInput = ''
		this.lastGameSearchSearch = ''

		this.prevMinute = -1

		const self = this
		this.tool.on('load', () => {
			self.channelActionsElement = document.querySelector('#channelactions')
			self.channelViewersplotter = document.querySelector('#channel_viewers')
			self.followsElement = document.querySelector('#myfollows')
			riot.mount(self.channelActionsElement)
			riot.mount(self.channelViewersplotter)
			riot.mount(self.followsElement)

			self.channelOpenInputElement = document.querySelector('#openchannel_input')
			self.channelOpenInputElement.onkeyup = function(e) {
				if(e.which == 13) {
					self._ui.startLoading()
					self.tool.twitchapi.getUserByName(self.channelOpenInputElement.value, (res, err) => {
						self._ui.stopLoading()
						if(res != null &amp;&amp; res.hasOwnProperty('users')) {
							if(res.users != null &amp;&amp; res.users.length > 0) {
								self.openChannel(res.users[0]._id)
							} else {
								self._ui.showErrorMessage(new Error(self.tool.i18n.__('No channel with this name was found.')))
							}
						} else {
							self._ui.showErrorMessage(err)
						}
					})
				}
			}

			riot.mount(document.querySelector('#ac_channel_game'), { callback: () => {
				document.querySelector('#ac_channel_game')._tag.setParentInput(document.querySelector('#channel_game'), 'below', (s) => { return self.searchGame(s) }, (el, replace) => {
					el.value = replace.value
				})
				document.querySelector('#channel_game').addEventListener('blur', () => { document.querySelector('#ac_channel_game')._tag.setSuggestions([]) })
			}})
			document.querySelector('#channel_status').addEventListener('keyup', (e) => {
				if(e.which == 13 &amp;&amp; self.openChannelId.length > 0) {
					e.target.disabled = true
					self.tool.twitchapi.updateChannel(self.openChannelId, { status: e.target.value }, (res, error) => {
						e.target.disabled = false
						if(res != null &amp;&amp; error == null &amp;&amp; res.hasOwnProperty('status')) {
							e.target.value = res.status
						} else {
							self._ui.showErrorMessage(error)
						}
					})
				}
			})
			document.querySelector('#channel_game').addEventListener('keyup', (e) => {
				if(e.which == 13 &amp;&amp; self.openChannelId.length > 0) {
					e.target.disabled = true
					self.tool.twitchapi.updateChannel(self.openChannelId, { game: e.target.value }, (res, error) => {
						e.target.disabled = false
						if(res != null &amp;&amp; res.hasOwnProperty('game')) {
							e.target.value = res.game
						} else {
							self._ui.showErrorMessage(error)
						}
					})
				}
			})

			/* Channel events */
			self.tool.channel.on('channelonline', () => {
				self.channelActionsElement._tag.addAction({ name: self.openChannelObject.display_name, color: self.tool.chat.userselement._tag.getUserColor(self.openChannelObject.name) }, self.tool.i18n.__('Channel is now online'), timestamp(new Date().getTime(), true))
			})
			self.tool.channel.on('channeloffline', () => {
				self.channelActionsElement._tag.addAction({ name: self.openChannelObject.display_name, color: self.tool.chat.userselement._tag.getUserColor(self.openChannelObject.name) }, self.tool.i18n.__('Channel is now offline'), timestamp(new Date().getTime(), true))
			})
			self.tool.channel.on('gamechange', (game) => {
				document.querySelector('#channel_game').value = game
				self.channelViewersplotter._tag.newColor()
				self.channelActionsElement._tag.addAction({ name: self.openChannelObject.display_name, color: self.tool.chat.userselement._tag.getUserColor(self.openChannelObject.name) }, self.tool.i18n.__('Game information changed to «{{game}}»', {game: game}), timestamp(new Date().getTime(), true))
			})
			self.tool.channel.on('statuschange', (status) => {
				document.querySelector('#channel_status').value = status
				self.channelActionsElement._tag.addAction({ name: self.openChannelObject.display_name, color: self.tool.chat.userselement._tag.getUserColor(self.openChannelObject.name) }, self.tool.i18n.__('Stream title changed to «{{status}}»', {status: status}), timestamp(new Date().getTime(), true))
			})
			self.tool.channel.on('viewers', (viewers) => {
				let cMinute = new Date().getMinutes()
				if(cMinute != self.prevMinute) {
					self.channelViewersplotter._tag.plotViewersCount(viewers, timestamp(new Date().getTime()))
					self.prevMinute = cMinute
				}
			})

			/* Follower events */
			self.tool.follows.on('follow', (user, raw) => {
				self.channelActionsElement._tag.addAction(user, self.tool.i18n.__('is following this channel now'), timestamp(raw.created_at, true))
			})

			
			/* Subscription events */
			// All subscriptions are coming via chat now
			/*this.tool.subscriptions.on('subscription', (user, raw) => {
				self.channelActionsElement._tag.addAction(user, self.tool.i18n.__('subscribed to this channel'), timestamp(raw.created_at, true))
			})*/


			/* Chat stuff */
			self.chatelement = document.querySelector('#channelchat')
			self.userselement = document.querySelector('#channeluser')
			self.messagelement = document.querySelector('#chat_message')
			self.emoticons = document.querySelector('#chat_message_emotes_emoticons')
			self.emoticons_container = document.querySelector('#chat_message_emotes')
			self.emoticons_button = document.querySelector('#chat_message_emotes_button')
			self.emoticons_search = document.querySelector('#chat_message_emotes_search')

			riot.mount(self.chatelement)
			riot.mount(self.userselement)
			riot.mount(document.querySelector('#ac_message_usernames'), { callback: userSuggestion })
			riot.mount(self.emoticons)

			self.tool.chat.once('userstate', (channel, user, tags) => {
				if(channel != self.openChannelObject.name) return
				self.userselement._tag.joinusr(user)
				if(typeof(tags['emote-sets']) == "string") {
					self.tool.twitchapi.getChatEmoticonsBySet(tags['emote-sets'], (data, err) => {
						if(err == null &amp;&amp; data != null &amp;&amp; data.hasOwnProperty('emoticon_sets')) {
							self.emoticons_data = data
							self.emoticons._tag.setemotes(data)
						}
					})
				}
			})
			
			self.joinTimeout = null // Joins come in bundles, so we just wait a second before updating
			self.tool.chat.on('join', (channel, user) => {
				if(channel != self.openChannelObject.name) return
				self.userselement._tag.joinusr(user, true)
				if(self.joinTimeout != null) {
					clearTimeout(self.joinTimeout)
					self.joinTimeout = null
				}
				self.joinTimeout = setTimeout(() => {
					self.joinTimeout = null
					self.userselement._tag.update()
				}, 2000)
			})
			self.tool.chat.on('part', (channel, user) => {
				if(channel != self.openChannelObject.name) return
				self.userselement._tag.partusr(user.user)
			})
			self.tool.chat.on('names', (channel, users) => {
				if(channel != self.openChannelObject.name) return
				self.messagelement.onkeyup = function(e){
					if(e.which == 13 &amp;&amp; self.openChannelObject.hasOwnProperty('name')) {
						self.tool.chat.sendmsg(self.openChannelObject.name, self.messagelement.value, self.emoticons_data)
						self.messagelement.value = ''
					}
				}
				for(var i = 0; i &lt; users.length; i++) {
					self.userselement._tag.joinusr(users[i], true)
				}
				self.userselement._tag.update()
			})
			self.tool.chat.on('usernotice', (channel, user, tags, msg) => {
				if(channel != self.openChannelObject.name) return
				if(tags['msg-id'] == 'resub') {
					self.channelActionsElement._tag.addAction(user,  self.i18n.__('subscribed for the {{months}}. month in a row!', {months: tags['msg-param-months']}), timestamp(parseInt(tags['tmi-sent-ts']), true))
				}
				if(tags['msg-id'] == 'sub') {
					self.channelActionsElement._tag.addAction(user,  self.i18n.__('subscribed with {{plan}} to this channel', {plan: tags['msg-param-sub-plan-name']}), timestamp(parseInt(tags['tmi-sent-ts']), true))
				}
			})
			self.tool.chat.on('clearuser', (channel, user, tags) => {
				if(channel != self.openChannelObject.name) return
				self.chatelement._tag.clearuser(user.user)
				if(tags.hasOwnProperty('ban-reason')) {
					let message = self.i18n.__('was banned from the channel.')
					let reason = self.i18n.__('There was no reason given.')
					if(tags['ban-reason'].length > 0) reason = '"' + tags['ban-reason'] + '"'
					if(tags.hasOwnProperty('ban-duration')) message = self.i18n.__('was timeouted for {{duration}} {{seconds||duration}}', { duration: tags['ban-duration'] })

					self.channelActionsElement._tag.addAction(user, message + '&lt;br>' + reason, timestamp(new Date().getTime(), true))
				}
			})
			self.tool.chat.on('clearchat', (channel, tags) => {
				if(channel != self.openChannelObject.name) return
				self.chatelement._tag.clearmessages()
			})
			self.tool.chat.on('hostingyou', (channel, user, viewers, msg, tags) => {
				let hostmessage = self.i18n.__('is hosting the channel')
				if(viewers > 0) {
					hostmessage = self.i18n.__('is hosting the channel with {{viewernum}} {{viewers||viewernum}}', { viewernum: viewers })
				}
				self.channelActionsElement._tag.addAction(user, hostmessage, timestamp(new Date().getTime(), true))
			})
			self.tool.chat.on('autohostingyou', (channel, user, viewers, msg, tags) => {
				let hostmessage = self.i18n.__('is auto hosting the channel')
				if(viewers > 0) {
					hostmessage = self.i18n.__('is auto hosting the channel with {{viewernum}} {{viewers||viewernum}}', { viewernum: viewers })
				}
				self.channelActionsElement._tag.addAction(user, hostmessage, timestamp(new Date().getTime(), true))
			})
			self.tool.chat.on('chatmessage', (channel, ts, user, message, msg_raw, type) => {
				if(channel != self.openChannelObject.name) {
					user.name = '(#' + channel +') ' + user.name
					type += 20
				}
				self.chatelement._tag.addmessage({
					'timestamp': ts,
					'badges_html': user.badges,
					'nickname': user.name,
					'message': msg_raw,
					'message_html': message,
					'user': user.user,
					'color': user.color,
					'type': type
				})
				if(user.user.length > 0 &amp;&amp; type == 0 &amp;&amp; channel == self.openChannelObject.name) {
					self.userselement._tag.joinusr(user)
				}
			})

			self.on('channelleft', () => {
				self.chatelement._tag.clearmessages()
				self.userselement._tag.clearUsers()
			})

			self.emoticons_button.addEventListener('click', () => {
				if(self.emoticons_container.style.display != 'block') {
					self.emoticons_container.style.display = 'block'
					self.emoticons_search.focus()
				} else {
					self.emoticons_container.style.display = 'none'
				}
			})
			self.emoticons_button.style.cursor = 'pointer'
			document.querySelector('#chat_column').addEventListener('click', (e) => {
				self.emoticons_container.style.display = "none"
			})
			self.emoticons_search.addEventListener('keyup', () => {
				self.emoticons._tag.filteremotes(self.emoticons_search.value)
			})
		})
		this.tool.auth.on('complete', () => {
			self.loadMoreFollows(true)
		})
	}

	get i18n() {
		return this._ui.i18n
	}

	get tool() {
		return this._ui.tool
	}

	/**
	 * Open the cockpit page
	 * 
	 * @override
	 */
	open() {
		this._visible = true
		if(this.openChannelId.length > 0) {
			document.querySelector('#content_cockpit').style.display = 'block'
		} else {
			document.querySelector('#content_follows').style.display = 'block'
			
		}
	}

	/**
	 * Closes the cockpit page
	 * 
	 * @override
	 */
	close() {
		this._visible = false
		document.querySelector('#content_cockpit').style.display = 'none'
		document.querySelector('#content_follows').style.display = 'none'
	}

	/**
	 * Loads more Follows for the channel list.
	 * 
	 * @param {Boolean} reset If true empties the list and begins from the start
	 */
	loadMoreFollows(reset) {
		const self = this
		if(typeof(reset) != 'boolean') reset = false
		if(reset) {
			this.followsOffset = 0
			this.followChannels = []
			this._ui.startLoading()
			this.tool.twitchapi.getChannel('', (res, err) => {
				self._ui.stopLoading()
				if(res != null &amp;&amp; res.hasOwnProperty('_id')) {
					self.followChannels.push(res)
					self.loadMoreFollows()
				} else {
					self._ui.showErrorMessage(err)
				}
			})
			return
		}
		this._ui.startLoading()
		this.tool.twitchapi.getUserFollows('', {'offset': this.followsOffset, 'sortby': 'last_broadcast', 'limit': (this.followChannels.length == 1 ? 9 : 10)}, (follows, err) => {
			self._ui.stopLoading()
			if(follows != null &amp;&amp; follows.hasOwnProperty('follows')) {
				self.followsOffset += follows.follows.length
				for(var i in follows.follows) {
					self.followChannels.push(follows.follows[i].channel)
				}
				self.followsElement._tag.update({ channels: self.followChannels })
			} else {
				self._ui.showErrorMessage(err)
			}
		})
	}

	/**
	 * Hides the channel list and opens up the chat for a channel. Will show an error message if a channel is already open. Loads channel information, badges and connects to the irc channel.
	 * 
	 * @param {String} channelid Id of the channel you want to open
	 * @fires Cockpit#event:channelopen
	 */
	openChannel(channelid) {
		const self = this
		if(this.openChannelId.length > 0) {
			showErrorMessage(new Error(this.i18n.__('You need to leave the current channel first')))
			return
		}
		
		document.querySelector('#channel_status').value = this.i18n.__('Please wait...')
		document.querySelector('#channel_game').value = ''

		this.openChannelId = channelid
		if(this._visible) {
			this.close()
			this.open()
		}
		if(!this.tool.chat.connected) {
			this._ui.startLoading()
			this.openChannelId = ''
			this.tool.chat.on('connected', () => {
				self._ui.stopLoading()
				self.openChannel(channelid)
			})
			return
		}

		this._ui.startLoading()
		this.tool.twitchapi.getChannel(channelid, (res, err) => {
			if(res != null &amp;&amp; res.hasOwnProperty('name')) {
				self.openChannelObject = res
				self.tool.twitchapi.getChatBadgeSetsByChannel(channelid, (badges, error) => {
					self._ui.stopLoading()
					if(badges != null &amp;&amp; badges.hasOwnProperty('badge_sets')) {
						self.tool.chat.channelbadges = badges.badge_sets
						self.tool.chat.join(self.openChannelObject.name)

						/**
						 * Fires when everything is loaded and ready
						 * @event Cockpit#channelopen
						 */
						this.emit('channelopen')
						
						/*if(periodicAPICallTimeout != null) {
							clearTimeout(periodicAPICallTimeout)
						}

						requestPeriodicAPIData()*/
					} else {
						self._ui.showErrorMessage(error)
					}
				})
				
			} else {
				self._ui.showErrorMessage(err)
			}
		})
	}

	/**
	 * Leaves the channel and displays the follows list.
	 */
	leaveChannel() {
		if(this.openChannelId.length &lt;= 0 || !this.openChannelObject.hasOwnProperty('name')) {
			return
		}
		this.tool.chat.part(this.openChannelObject.name)
		this.openChannelId = ''
		this.isChannelOnline = true
		this.openChannelObject = {}
		this.prevMinute = -1
		this.prevGame = ''


		if(this._visible) {
			this.close()
			this.open()
		}

		this.channelActionsElement._tag.clearActions()
		this.channelViewersplotter._tag.clearPlotter()
		/**
		 * Fires when the user left the channel
		 * @event Cockpit#channelleft
		 */
		this.emit('channelleft')
		/*latestFollow = 0
		latestSubscriptions = 0
		skipSubscriptions = false*/

		this.loadMoreFollows(true)
	}

	/**
	 * Searches for a game and shows a suggestion list for the game entry field.
	 * 
	 * @param {String} str Needle to search for
	 * @returns {Array} This array is always empty
	 * @memberof Cockpit
	 */
	searchGame(str) {
		const self = this
		this.lastGameSearchInput = str
		if(str.length > 3 &amp;&amp; !this.isGameSearching) {
			if(this.gameSearchTO != null) clearTimeout(this.gameSearchTO)
			this.gameSearchTO = setTimeout(() => {
				self.isGameSearching = true
				self.lastGameSearchSearch = self.lastGameSearchInput
				self.tool.twitchapi.searchGames(str, {}, (res, error) => {
					self.isGameSearching = false
					if(res != null &amp;&amp; res.hasOwnProperty('games')) {
						if(res.games == null) res.games = []
						let games = []
						for(let i = 0; i &lt; res.games.length; i++) {
							games.push({ display: res.games[i].name, value: res.games[i].name })
						}
						document.querySelector('#ac_channel_game')._tag.setSuggestions(games)
						if(self.lastGameSearchInput != self.lastGameSearchSearch) {
							self.searchGame(self.lastGameSearchInput)
						}
					}
				})
			}, 500)
		}
		return []
	}
}
module.exports = Cockpit</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="img/toast-ui.png" style="width: 0px; height: 0px">
    <div class="footer-text">Code by PakL</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
