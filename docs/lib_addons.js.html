<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/addons.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="TTVTool.html">TTVTool</a></li><li><a href="ToolUI.html">ToolUI</a><ul class='methods'><li data-type='method'><a href="ToolUI.html#findPage">findPage</a></li><li data-type='method'><a href="ToolUI.html#addPage">addPage</a></li><li data-type='method'><a href="ToolUI.html#openPage">openPage</a></li><li data-type='method'><a href="ToolUI.html#addMenu">addMenu</a></li><li data-type='method'><a href="ToolUI.html#getMenuItemById">getMenuItemById</a></li><li data-type='method'><a href="ToolUI.html#startLoading">startLoading</a></li><li data-type='method'><a href="ToolUI.html#stopLoading">stopLoading</a></li><li data-type='method'><a href="ToolUI.html#showErrorMessage">showErrorMessage</a></li></ul></li><li><a href="TwitchTv.html">TwitchTv</a><ul class='methods'><li data-type='method'><a href="TwitchTv.html#getAuthImplicitGrantFlowUrl">getAuthImplicitGrantFlowUrl</a></li><li data-type='method'><a href="TwitchTv.html#verifyState">verifyState</a></li><li data-type='method'><a href="TwitchTv.html#setAuthToken">setAuthToken</a></li><li data-type='method'><a href="TwitchTv.html#getAuthToken">getAuthToken</a></li><li data-type='method'><a href="TwitchTv.html#isLoggedIn">isLoggedIn</a></li><li data-type='method'><a href="TwitchTv.html#requestAPI">requestAPI</a></li><li data-type='method'><a href="TwitchTv.html#getUser">getUser</a></li><li data-type='method'><a href="TwitchTv.html#getUserByName">getUserByName</a></li><li data-type='method'><a href="TwitchTv.html#getUserFollows">getUserFollows</a></li><li data-type='method'><a href="TwitchTv.html#getChannel">getChannel</a></li><li data-type='method'><a href="TwitchTv.html#updateChannel">updateChannel</a></li><li data-type='method'><a href="TwitchTv.html#getChannelFollowers">getChannelFollowers</a></li><li data-type='method'><a href="TwitchTv.html#getChannelSubscribers">getChannelSubscribers</a></li></ul></li><li><a href="UIPage.html">UIPage</a><ul class='methods'><li data-type='method'><a href="UIPage.html#open">open</a></li><li data-type='method'><a href="UIPage.html#close">close</a></li></ul></li><li><a href="Addons.html">Addons</a></li><li><a href="ToolSettings.html">ToolSettings</a><ul class='methods'><li data-type='method'><a href="ToolSettings.html#setLanguage">setLanguage</a></li><li data-type='method'><a href="ToolSettings.html#addHighlight">addHighlight</a></li><li data-type='method'><a href="ToolSettings.html#getBoolean">getBoolean</a></li><li data-type='method'><a href="ToolSettings.html#setBoolean">setBoolean</a></li><li data-type='method'><a href="ToolSettings.html#getString">getString</a></li><li data-type='method'><a href="ToolSettings.html#setString">setString</a></li><li data-type='method'><a href="ToolSettings.html#getJSON">getJSON</a></li><li data-type='method'><a href="ToolSettings.html#setJSON">setJSON</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="TTVTool.html#event:load">load</a></li><li><a href="TTVTool.html#event:exit">exit</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-Getting Started.html">Getting Started</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/addons.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict"

const {remote} = require('electron')
const {app} = remote.require('electron')
const exec = require('child_process').exec;
const fs = require("fs")
const https = require("../node_modules/follow-redirects").https
const UIPage = require('../mod/uipage')
const requireUncached = require('../node_modules/require-uncached')

/**
 * 
 * @param {TTVTool} tool
 * @class Addons
 */
class Addons {

	constructor(tool) {
		this.tool = tool

		this.addons = []
		this.addonnames = []
		this.package_infos = {}
		this.available_addons = []
		this.possibleAddon = ''

		let curdir = fs.realpathSync('.')
		let addonsDir = []
		try {
			fs.accessSync('addons')
			let addonsDird = fs.readdirSync('addons')

			for(let i = 0; i &lt; addonsDird.length; i++)
				addonsDir.push('addons/' + addonsDird[i])
		} catch(e) {}
		try {
			fs.accessSync('resources')
			let resourcesDir = fs.readdirSync('resources')

			for(let i = 0; i &lt; resourcesDir.length; i++)
				addonsDir.push('resources/' + resourcesDir[i])
		} catch(e) {}

		console.log('Checking addons: ' + addonsDir.join(', '))
		
		let infos = {}
		let lang = null
		for(let i = 0; i &lt; addonsDir.length; i++) {
			infos = {}
			lang = null
			try {
				fs.accessSync(`${addonsDir[i]}/package.json`)
				fs.accessSync(`${addonsDir[i]}/addon.js`)

				let pack = fs.readFileSync(`${addonsDir[i]}/package.json`, { encoding: 'utf8' })
				infos = JSON.parse(pack)
			} catch(e) {}
			try {
				fs.accessSync(`${addonsDir[i]}/language.json`)
				lang = requireUncached('../node_modules/i18n-nodejs')(this.tool.settings.language, `${curdir}/${addonsDir[i]}/language.json`)
			} catch(e) {}

			if(infos.hasOwnProperty('name') &amp;&amp; infos.hasOwnProperty('systems')) {
				if(infos.systems.indexOf(process.platform) >= 0) {
					try {
						let addon = require(`${curdir}/${addonsDir[i]}/addon`)

						this.addons.push(new addon(this.tool, lang))
						console.log('Addon ' + addonsDir[i] + ' is being loaded')
						this.addonnames.push(infos.name)
						infos.file = `${curdir}/${addonsDir[i]}`
						this.package_infos[infos.name] = infos
					} catch(e) {
						console.log('Error loading addon ' + addonsDir[i])
						console.error(e)
					}

				} else {
					console.log('Addon ' + addonsDir[i] + ' is not compatible with the current platform')
				}
			} else {
				console.log('Addon ' + addonsDir[i] + ' has no platform informations')
			}
		}

		const self = this
		this.tool.on('load', () => {
			for(let i = 0; i &lt; self.addons.length; i++) {
				if(self.addons[i] instanceof UIPage) {
					self.tool.ui.addPage(self.addons[i])
				}
			}
			self.loadPackages()
		})
	}


	addonInstalled(name) {
		if(this.addonnames.indexOf(name) >= 0) {
			return true
		}
		return false
	}

	getInstalledAddonVersion(name) {
		if(typeof(this.package_infos[name]) == "undefined" || typeof(this.package_infos[name].version) == "undefined") {
			return "Unkown"
		}
		return this.package_infos[name].version
	}

	getAddon(name) {
		let i = this.addonnames.indexOf(name)
		if(i >= 0) {
			return this.addons[i]
		}
		return null
	}

	get menu() {
		const self = this

		let m = []
		let update = false
		for(let i = 0; i &lt; this.available_addons.length; i++) {
			let a = this.available_addons[i]
			let mi = {
				label: a.name + ' (v' + (this.addonInstalled(a.name) ? this.getInstalledAddonVersion(a.name) : a.version)+ ')',
				type: 'checkbox',
				checked: this.addonInstalled(a.name),
				click: () => { self.addonclick(a.name) }
			}
			m.push(mi)

			if(this.addonInstalled(a.name)) {
				if(self.getInstalledAddonVersion(a.name) != a.version) {
					update = true
					self.possibleAddon = a.name
				}
			}
		}
		if(update) {
			m.push({type: 'separator'})
			m.push({label: 'Update available. Update now!', click: () => { self.updateclick() }})
		}

		return new MenuItem({
			label: 'Addons',
			submenu: Menu.buildFromTemplate(m)
		})
	}

	addonclick(addonname) {
		if(this.addonInstalled(addonname)) {
			if(this.package_infos[addonname].file.endsWith('.asar')) {
				let modal = this.tool.ui.showErrorMessage(new Error(this.tool.i18n.__('Uninstalling {{addon}} now... Program will restart.', {addon: addonname})))
				modal.onclick = () => {}
				setTimeout(() => {
					exec('cmd /C "ping 127.0.0.1 -n 2 > NUL &amp; del "' + this.package_infos[addonname].file.replace(/\//g, '\\') + '" &amp; "' + process.execPath + '"')
					app.quit()
				}, 5000);
			} else {
				this.tool.ui.showErrorMessage(new Error(this.tool.i18n.__('Cannot uninstall. For uninstall the addon must be a asar addon.', {addon: addonname})))
			}
		} else {
			let downloadurl = ''
			for(let i = 0; i &lt; this.available_addons.length; i++) {
				let a = this.available_addons[i]
				if(addonname == a.name) {
					downloadurl = a.url
				}
			}
			if(downloadurl.length > 0) {
				let modal = this.tool.ui.showErrorMessage(new Error(this.tool.i18n.__('Downloading and installing {{addon}} now... Program will restart.', {addon: addonname})))
				modal.onclick = () => {}

				https.get(downloadurl, (resp) => {
					if(resp.statusCode == 200) {
						fs.writeFileSync('resources/' + addonname + '.part', Buffer.alloc(0))
						resp.on('data', (chunk) => { fs.appendFileSync('resources/' + addonname + '.part', chunk) })
						resp.on('end', () => {
							fs.renameSync('resources/' + addonname + '.part', 'resources/' + addonname + '.asar')
							exec('cmd /C "ping 127.0.0.1 -n 2 > NUL &amp; "' + process.execPath + '"')
							app.quit()
						})
					} else {
						app.quit()
					}
				})
			} else {
				this.tool.ui.showErrorMessage(new Error(this.tool.i18n.__('Could not find anything to download.')))
			}
		}
	}

	updateclick() {
		const self = this
		let addonname = this.possibleAddon
		if(addonname.length &lt;= 0) return
		let downloadurl = ''
		for(let i = 0; i &lt; this.available_addons.length; i++) {
			let a = this.available_addons[i]
			if(addonname == a.name) {
				downloadurl = a.url
			}
		}
		if(downloadurl.length > 0) {
			let modal = this.tool.ui.showErrorMessage(new Error(this.tool.i18n.__('Downloading and updating {{addon}} now... Program will restart.', {addon: addonname})))
			modal.onclick = () => {}

			https.get(downloadurl, (resp) => {
				if(resp.statusCode == 200) {
					fs.writeFileSync('resources/' + addonname + '.part', Buffer.alloc(0))
					resp.on('data', (chunk) => { fs.appendFileSync('resources/' + addonname + '.part', chunk) })
					resp.on('end', () => {
						exec('cmd /C "ping 127.0.0.1 -n 2 > NUL &amp; del "' + self.package_infos[addonname].file.replace(/\//g, '\\') + '" &amp; copy resources\\' + addonname + '.part resources\\' + addonname + '.asar &amp; del resources\\' + addonname + '.part &amp; "' + process.execPath + '"')
						app.quit()
					})
				} else {
					app.quit()
				}
			})
		} else {
			this.tool.ui.showErrorMessage(new Error(this.tool.i18n.__('Could not find anything to download.')))
		}
	}

	loadPackages() {
		const self = this
		https.get('https://vs.paklweb.de/ttvst/addons.php', (res) => {
			if(res.statusCode == 200) {
				res.setEncoding('utf8')
				let addons_json = ''
				res.on('data', (chunk) => { addons_json += chunk })
				res.on('end', () => {
					try {
						let addons = JSON.parse(addons_json)
						self.available_addons = addons
						self.tool.ui.addMenu(self.menu)
					} catch(e) {
						console.error(e)
					}
				})
			}
		})
	}

}
module.exports = Addons</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Sun Jul 16 2017 12:35:04 GMT+0200 (Mitteleuropäische Sommerzeit) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
